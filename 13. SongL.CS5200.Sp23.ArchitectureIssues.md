# Question 1

> What are cursors? Why are they useful in application architectures? What are some of the benefits? Are there drawbacks to cursors? How do MySQL and SQLite support cursors and how would you (in one of them) use them? Provide a 300-500 word explanation of cursors.

### What are cursors

Cursor is a database object that can be used to iterate one row or a group of rows of a SQL query result. It is a temporary work area in memory to store retrieved data, which is usually a set of rows, and it can access one row of the set each time. It acts like a pointer to one certain row of the result set, and can move to other rows as needed.

There are two types of cursors in SQL: implicit cursor and explicit cursor. An implicit cursor is generated by the DBMS when an INSERT, UPDATE, DELETE or SELECT one single row is executed. While an explicit cursor is generated by the user when a SELECT is applied for several rows. The cursor must be declared and then executed. An explicit cursor would store more than one row, but still, only one row would be accessed at a time.

In addition, cursors can also be divided into FORWARD _ONLY and SCROLL based on scrolling capabilities, or STATIC, KEYSET, and DYNAMIC based on data sensitivity.

### Usage of cursors

Cursor makes it possible to visit certain rows of the result set without loading the entire one. It is typically used when operating large datasets that are too large to fit into memory, or when performing complex operations. It can also be applied when operations need to be accomplished on specific criteria, e.g. in a specific order.

Cursors can also be useful to avoid update failures because of one error of one single row. For example, the following UPDATE would fail if it encounters one error in some row, and the entire UPDATE will not be executed with no rows being updated. Yet with a cursor, we can iterate each row and skip one row with errors. 

```
UPDATE Users
SET isAcitve = TRUE
WHERE salesAmount > 1000
```

### Benefits of cursors

- Reduce memory consumption. Cursors can store result sets of SQL, and retrieve and manipulate them for needs. The memory consumption would be reduced, especially for a large-scale data set, as the original data set would not be retrieved each time.

- Process complex operations. For operations with some extra criteria or from multiple tables with complex relationships, cursors can be useful as it simplifies the required steps by only visiting result sets.

- Handle errors. As we mentioned above, as any operation would be handled row by row, we can handle errors in one specific row, without the failure of the entire operation. SCROLLABLE cursors can even support roll back when an error occurs.

### Drawbacks of cursors

- Cursors can be slower compared with other database process methods. Cursors would retrieve only one row of the data set each time, while other methods would retrieve a bulk of data each time. This can result in much more query times when using a cursor, which can reduce the performance, especially for a large amount of data.

- Cursors can consume more resources such as processors and network traffic. For the similar reason above, cursors would execute more queries than other methods that select or update data in batches rather than rows. And more database queries can occupy much more resources.

### Cursor in MySQL

In MySQL, a cursor is asensitive, read-only, and non-scrollable. Asensitive means the cursor points to the actual data rather than a temporary copy. Compared with insensitive cursor which creates a copy of the original data, asensitive cursor can be faster. Yet changes would be made directly to the original data which means more dangerous if executing an update. Read-only means the cursor can not update data but only read them. Non-scrollable means the cursor can only visit rows in one order and can not skip rows or in reversed order.

To use a cursor in MySQL, the following steps should be followed:

- *Declare a cursor*. Use `DECLARE` statement followed by a `SELECT` statement to declare a cursor.

```
DECLARE cursor_name CURSOR FOR SELECT_statement;
```
- *Open a cursor*. Use `OPEN` statement to open the declared cursor and initialize the result set.

```
OPEN cursor_name;
```

- *Fetch a cursor*. Use `FETCH` statement to retrieve the next row that the cursor is pointing to, and advance the cursor to the next row. The fetched columns would be stored in the variable list.

```
FETCH cursor_name INTO var_list;
```

- *Close a cursor*. Use `CLOSE` statement to deactivate a cursor and release the memory.

```
CLOSE cursor_name;
```

### Cursor in SQLite

SQLite also supports cursors and the basic concepts are generally the same, while the steps of creating and using cursors are a bit different.

- *Create a cursor instance*. Use `cursor()` method of a connection to create a cursor instance, rather than `DECLARE`.

```
cursor = conn.cursor();
```

- *Execute a query*. Use `execute()` method of a cursor to execute a SQL query and store result sets in the cursor.

```
cursor.execute(SELECT_statment)
```

- *Fetch a cursor*. Use `fetchone()` method to get the next row of the result set, or use `fetchmany()` or `fetchall()` to get multiple rows of the result set.

```
row = cursor.fetchone()
rows = cursor.fetchmany(size)
rows = cursor.fetchall()
```

- *Close a cursor*.

```
cursor.close()
```

### References 

- Choudhary, P.K. "What is a Cursor in SQL? And when to use a Cursor?". C#Corner, Feb 20, 2023. https://www.c-sharpcorner.com/UploadFile/f0b2ed/cursors-in-sql/#:~:text=A%20cursor%20in%20SQL%20is%20a%20database%20object%20stored%20in,one%20row%20at%20a%20time.

- MySQLTutorial. "MySQL Cursor". https://www.mysqltutorial.org/mysql-cursor/.

- Python. "sqlite3 â€” DB-API 2.0 interface for SQLite databases". https://docs.python.org/3/library/sqlite3.html#cursor-objects

- Wenzel, K. "What is a Database Cursor?". essentialSQL, Mar 06, 2022. https://www.essentialsql.com/database-cursor/.

- Wikipedia. "Cursor (databases)". https://en.wikipedia.org/wiki/Cursor_(databases)#:~:text=Cursors%20are%20used%20by%20database,rows%20in%20a%20result%20set.


# Question 2

> What are connection pools? Why are they useful in application architectures? What are some of the benefits? Are there any potential drawbacks? What are some of the main issues with using connection pools? Provide a 300-500 word explanation of connection pools.

### What are connection pools

A connection pool is a cache of database connections that are maintained to be ready for future user requests. It is a strategy to improve performance by reusing existing database connections rather than creating and closing connections for each database operation.

Each time the application executes an access to a database, a connection would be created, maintained, and released. This process can be costly and waste resources. Through a connection pooling, each time the connection is created, it would be added to a backend pool of connections that the application server can share. The connections in the pool would be reused again rather than recreating new connections.

### Usage of connection pools

Connection pools are commonly used in application architectures as they can help to reduce the overhead of establishing new connections, and reduce the response time. When the application is at small scale, this cost can be ignorable, while when the application scales up, the expense of establishing connections can be expensive and slow.

Connection pools would be extremely useful for dynamic web pages, as these pages require constant opening and closing connections to the database. Local applications can also apply a connection pool if they require frequent access to the database. 

### Benefits of connection pools

- Eliminate the overhead of connections. The cost of creating new connections and disconnections would be eliminated. With a connection pool, only resources that are used to initialize new connections in the pool would be consumed, and the costs of connection reuse would be insignificant.

- Improve performance. Establishing a new connection involves opening a new connection, opening a network socket, validating user credentials, closing the network socket, etc. This series of operations must be executed before the query can actually run in the database server, which can slow the response time. This effect can be more significant for large-scale web-based servers, because of the limitation of the Internet bandwidth, processing ability of server hardwares, etc.

- Reduce the load of database servers. The number of connections to a database server can affect its performance. A database's ability to handle connections and queries is limited because of the hardware capability. Without a connection pool, the number of connections can easily reach the limit, and additional connection requests would be rejected. Connection pooling can help to reduce the connection load of the database server.

### Drawbacks of connection pools

- Cost to maintain a connection pool. Connection pools are maintained in the memory that can be costly to maintain, especially when the pool contains a large amount of connections. In addition, whenever we tend to start a connection, the entire connection pool would be opened and maintained, which can be expensive.

- Possible connection failures. When all connections in the connection pool are used, or connections are not properly configured, it would be possible to get a connection failure. 

### References 

- Custer, C. "What is connection pooling, and why should you care". Nov 30, 2021. https://www.cockroachlabs.com/blog/what-is-connection-pooling/.

- IBM. "Connection pooling". Jan 26, 2023. https://www.ibm.com/docs/en/was/9.0.5?topic=architecture-connection-pooling.

- Prisma's Data Guide. "Database tools". https://www.prisma.io/dataguide/database-tools/connection-pooling

- Pugh, E.; Gradecki, J. D. (Nov 11, 2005). "Professional Hibernate". John Wiley & Sons. p65.

- Wikipedia. "Connection pool". https://en.wikipedia.org/wiki/Connection_pool.


# Question 3

> Write an 800 - 1000 word review of the two articles (combine the two reviews; do not write two separate reviews). What are the main issues they address? List three things that you learned or three key take-aways (from either of the two papers). Are there statements that you do not agree with?
> - Atoum, J. O., & Qaralleh, A. J. (2014). A hybrid technique for SQL injection attacks detection and prevention. International Journal of Database Management Systems, 6(1), 21.
> - Halfond, W. G., Viegas, J., & Orso, A. (2006, March). A classification of SQL-injection attacks and countermeasures. In Proceedings of the IEEE international symposium on secure software engineering (Vol. 1, pp. 13-15). IEEE.

### Main Issues

**What are SQL injection attacks (SQLIAs)**

SQLIA is a kind of code-injection attack when an attacker injects a malicious SQL query as part of the user's input to get unauthorized access to the application's database. The vulnerable databases are often those containing sensitive user information, so the SQLIAs can usually lead to identity theft or loss of confidential data.

The mechanism of SQLIAs is simple to be understood: they often occur when the application fails to properly validate the user input before executing it as part of a SQL query. For example, the attacker could insert new SQL keywords or operators to change the intended purpose of the SQL. As a result, an inexperienced attacker can execute an SQLIA and accomplish one attack.

Apart from *injection through user input*, there are also some other mechanisms: 
    - *Injection through cookies*. It happens when the web application uses cookies to build SQL queries, and the attacker inserts malicious content into the cookies.
    - *Injection through variables*. It happens when the web application uses server variables such as HTTP, or network headers, to log into a database, and the attacker forges values in the variables to insert SQLIAs.
    - *Second-order injection*. It happens when the attacker inserts SQLIA that will not be used directly, but executed later. It is harder to be detected and prevented.

In addition, the intents or goals of SQLIAs vary:
    - Determining database schema
    - Data gathering
    - Database manipulation
    - Code injection
    - Function call injection
    - Buffer overflows
    - Authentication bypass
    - Privilege escalation
    - ...

**SQLIAs Classifications**

- *Tautologies*. Tautologies are a type of SQLIA where the attacker inserts a logical expression that always equals `TRUE`. This attack is usually used to bypass the authentication to get valid credentials or permissions. For example, the following SQL statement is a tautology-based query. The `OR 1=1` makes the `WHERE` clause always equals `TRUE`. As a result, the SQL would retrieve all rows in the `users` table. The attacker could then use the access to perform further actions.

```
SELECT * FROM users WHERE username = 'admin' AND password = 'OR 1=1 --';
```

- *Illegal/Logically Incorrect Queries*. An attacker may insert a SQL query that violates syntax or DBMS rules and make the database return an error page. The error page can be used to extract information about the database schema, system configuration, or other sensitive information. The following is an example of an illegal query. The `--` comments out other codes, and `DROP TABLE users` would make the database return an error. The error may contain database schema such as column data types.

```
SELECT * FROM users WHERE username = 'admin; DROP TABLE users; --' AND password = '';
```

- *Union Query*. An attacker may apply a `UNION` operator in a SQL query to get results of one or more `SELECT` statements. It can be used to retrieve data from the database that is not supposed to be accessible. This is a union query example that selects all `account` and `name` columns from table `admins`.

```
SELECT account, name FROM users WHERE username = '1' UNION SELECT account, name FROM admins;
```

- *Piggy-Backed Queries*. This refers to the injection of additional SQL statements into a normal SQL query. After the normal query is executed, the attacker can execute any type of SQL command afterward, which can be extremely harmful. The purpose of piggy-backed queries is usually to retrieve additional information or perform unauthorized actions. The following example includes a `DROP TABLE` command after `;` that may be executed to drop table `users`.

```
SELECT * FROM users WHERE username = 'admin; DROP TABLE users;--';
```

- *Stored Procedures*. Stored procedures are a common feature in DBMS but also can be used by SQLIAs. However, attackers can also insert malicious content into a stored procedure, as most stored procedures follow a standard format in a specific database. Once the attacker knows the type of back-end database we are using, the stored procedure can be called and executed with inserted various types of attacks.

- *Inference*. For a secure enough database, the error messages would not reveal sensitive information to the users. The attacker may then try to inject commands to the database and see how the database's behavior changes, and deduce additional information, such as vulnerable parameters, based on them. For example, the first statement in the following statement would always return an error whether in a secure or insecure database. However, the second statement would not return an error in an insecure database. The attacker would know the `username` is a vulnerable parameter. 

```
SELECT * FROM users WHERE username = 'admin' AND 1=0 --' AND password = '';
SELECT * FROM users WHERE username = 'admin' AND 1=1 --' AND password = '';
```

- *Alternate Encodings*. The attacker would use different encodings (e.g. hexadecimal, ASCII, Unicode) to the original attack strings to evade detection or prevention techniques. This method is always combined with other types of attacks. For example, in the above instance, the single quote can be replaced by `\u0027` in Unicode.

**Techniques for detecting and preventing SQLIAs**

- *Black Box Testing*. This technique uses a web crawler to identify all points that can be injected SQLIAs and execute attacks. Then it applies a machine learning approach to analyze the database's responses to improve the attack methodology. Yet it cannot guarantee to cover all kinds of attacks as a black box. Example: `WAVES`.

- *Static Analysis*. This technique is used to improve the checking ability of user input by detecting weaknesses in the source codes before applying them. It can normally detect tautologies but cannot detect type correct and legal queries. Example: `JDBC-Checker`.

- *Runtime Analysis*. This technique is used to detect any SQLIAs by monitoring the execution of the system.

- *Combined Static and Runtime Analysis*. In the static phase, this technique would build models of any legal queries. And in the runtime phase, the technique would check all queries sent to the database and dynamically modify the model. Any queries that violate the model would be identified as SQLIAs. This method relies on the accuracy of the static analysis of source codes. Example: `AMNESIA`, `SQLGuard`, `SQLCheck`.

- *Taint Based Approaches*. This kind of techniques apply static analysis or dynamic analysis to information flow to detect taint input. The analysis would suggest preconditions that would be considered to be SQLIAs and generate a set of filters. However, identifying all tainted information is not easy to complete. Example: `WebSSARI`.

- *New Query Development Paradigms*. These techniques apply a new programming paradigm to the query-building process by introducing their APIs. The new process would execute type check or filter well. However, this means developers have to learn a new paradigm or developing process. Example: `SQL DOM`, `Safe Query Objects`.

- *Intrusion Detection Systems*. IDS applies a machine learning technique to train the model with typical queries, and identify queries that do not fit the model. Its performance replies on the scale of the training set. Example: `IDS`.

- *Proxy Filters*. This technique executes input validation rules by applying constraints and transformations to the input parameters. It relies on the developers' filter pattern and content. Example: `Security Gateway`.

- *Instruction Set Randomization*. This kind of techniques create randomized commands in queries and use Proxy Filters to de-randomize them. It can be very useful as SQLIAs would not be built using randomized instruction set. However, this relies on the security of randomization and de-randomization keys. Example: `SQLrand`

- *Hybrid technique in paper 1*. The first paper introduced a hybrid technique by the below approaches.
    - Replicate system databases containing a small set of data.
    - Creating "database_Behaviors" database containing all system database queries.
    - Redirect SQL queries to the virtual replicated database.
    - Simple SQL syntax checking.
    - Virtual execution in the replicated database.
    - SQLIA detection by comparing behaviors with the same type query in the "database_Behaviors". 

### Evaluation of techniques

The two papers all evaluate various techniques' abilities to detect and prevent different kinds of SQLIAs. All techniques can handle several kinds of SQLIAs, while the hybrid technique in paper 1 can cover all kinds of SQLIAs and is the only technique that can prevent a direct attack and prevent attacks using built-in functions.

In addition, paper 2 found some common vulnerable points such as attacks using poorly-coded stored procedures or alternate encodings.

### Three things I learned

1. There are so many vulnerabilities that can be used to execute SQLIAs, and many types of SQLIAs are so easy to implement and execute. The security of information is a severe problem that every developer should put high importance on. A loss of information or an authorized action can result in a great cost.

2. There is no perfect protection technique, not only because of the enormous types of SQLIAs, but because of the growth of new attack methods. It would be a long-term game to fight with SQLIAs and protect systems. Developers or database administrators should always be alert of any new kinds of SQLIAs. In addition, almost all detection and prevention techniques have drawbacks. It would be a trade-off to choose suitable techniques for a database.

3. As a Data Science student, I am glad to see that many machine learning approaches were applied in protection techniques. Machine Learning methods are developing fastly recent years, especially in the deep learning and AI area. These methods may be useful to provide more powerful detection ability and provide stronger protection. This could be a direction full of potential.

### Statements I do not agree with

The hybrid technique in paper 1 seems to have the ability to detect all kinds of SQLIAs. However, this ability relies on the completeness of `database_Behaviors` database, which has to be maintained to be effective against any new SQLIAs.

In addition, the suspicious queries may contain false positive queries that are identified as malicious by mistake. This is also not explored in the paper.